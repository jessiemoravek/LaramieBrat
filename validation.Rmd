---
title: "Validation"
output: html_document
date: "2025-08-12"
---

```{r message=FALSE, include=FALSE}

library(tidyverse)
library(ggplot2)
library(dplyr)
library(dataRetrieval)
library(viridis)
library(MetBrewer)
library(ggpmisc)
library(quantreg)
```

##Set working directory (folder everything gets saved into)
```{r}
#check working directory (what folder are you saving/pulling from?)
getwd()

#set working directory (decide which folder you want all your saved files to live in)
setwd("C:/Users/morav042/Documents/LaramieBrat") #Replace with your folder of choice

```

##Import table
```{r}
#If you set your working directory, you don't need the entire file path, just the file name! If you did NOT set your wd, you need the entire file path. I recommend you always set a wd. 

#Replace with your csv file name here:
df <- read_csv("Crow_Capacity.csv")
```


##Categorize Predicted Dam Capacity
```{r}
df <- df %>% 
  mutate(category = case_when(oCC_EX >= 15 ~ "Pervasive",
                    oCC_EX >= 5 ~ "Frequent",
                    oCC_EX >= 1 ~ "Occasional",
                    oCC_EX > 0 ~ "Rare",
                    oCC_EX == 0 ~ "None")
  )
```

##Group into categories and calculate averages
```{r}
#Grouping
grouped_df <- df %>%
  group_by(category) %>%
  summarize(mean_predicted = mean(oCC_EX),
            mean_observed = mean(DamKM))

##re order categories by factor for plotting
grouped_df$category <- factor(grouped_df$category, levels = c("Pervasive", "Frequent", "Occasional", "Rare", "None"))

```

##Plot Observed vs Predicted (averaged by category)
```{r}
ggplot(grouped_df, aes(mean_predicted, mean_observed, col = category))+
  geom_point(size = 3)+
  stat_poly_line(mapping = aes(group = 1), se= FALSE, method="lm", color = "black") +
  stat_poly_eq(mapping = aes(group = 1)) +  #make sure statistics do not consider the color grouping, which is just for visualization
  scale_color_manual(values = c("Pervasive" = "blue",
                                "Frequent" = "green",
                                "Occasional" = "yellow",
                                "Rare" = "orange",
                                "None" = "red"))+
  labs(title = "Observed vs Predicted Dam Densities Averaged by Category",
       x = "Predicted Maximum Capacity (dams/km)",
       y = "Observed Dam Density (dams/km)") +
  theme_classic()

##Note: you will get a warning that "the following aesthetics were dropped during statistical transformation..." this is fine! I did that on purpose! 
```

##Observed vs Predicted dam densities
###CAN"T FIGURE OUT LEGEND
```{r}
#change 0 to NA in observed
df$DamKM_NA <- df$DamKM
df$DamKM_NA[df$DamKM_NA == 0] <- NA


ggplot(df, aes(oCC_EX, DamKM_NA))+
  geom_point(shape = 4, color = "blue", size = 2)+
  scale_x_continuous(limits = c(0,30))+
  geom_abline(color = "red", linewidth = 1)+ #1:1
  stat_quantile(quantiles = 0.5, formula = y ~ x + 0, linetype = 2, color = "black", linewidth = 1)+ #dashed
  stat_quantile(quantiles = 0.75, formula = y ~ x + 0, linetype = 3, color = "black", linewidth = 1)+ #dotted
  stat_quantile(quantiles = 0.9, formula = y ~ x + 0, linetype = 4, color = "black", linewidth = 1)+ #dotdash
  labs(title = "Observed vs Predicted Dam Densities",
       x = "Predicted Maximum Capacity (dams/km)",
       y = "Observed Dam Density (dams/km)", 
      legend_position = "right") +
  theme_classic()

#SORRY CAN'T MAKE A LEGEND
# 1:1 = red 
# 90% quantile = dotdash
# 75% quantile = dotted
# 50% quantile = dashed

```







#Need a better statistical test for this
```{r}
ggplot(df, aes(oCC_EX, DamKM, col = category))+
  geom_point(size =1)+
  stat_poly_line(mapping = aes(group = 1), se= FALSE, method="lm", color = "black") +
  stat_poly_eq(mapping = aes(group = 1)) +  #make sure statistics do not consider the color grouping, which is just for visualization
  scale_color_manual(values = c("Pervasive" = "blue",
                                "Frequent" = "green",
                                "Occasional" = "yellow",
                                "Rare" = "orange",
                                "None" = "red"))+
  labs(title = "Observed vs Predicted Dam Densities",
       x = "Predicted Maximum Capacity (dams/km)",
       y = "Observed Dam Density (dams/km)") +
  theme_classic()

##This implies to me that we need to remove zeros, lots of reaches with no beaver dams but not necessarily bc there CAN'T be beaver dams
```

```{r}
#change 0 to NA in observed
df$DamKM_NA <- df$DamKM
df$DamKM_NA[df$DamKM_NA == 0] <- NA

ggplot(df, aes(oCC_EX, DamKM_NA, col = category))+
  geom_point(size =1)+
  stat_poly_line(mapping = aes(group = 1), se= FALSE, method="lm", color = "black") +
  stat_poly_eq(mapping = aes(group = 1)) +  #make sure statistics do not consider the color grouping, which is just for visualization
  scale_color_manual(values = c("Pervasive" = "blue",
                                "Frequent" = "green",
                                "Occasional" = "yellow",
                                "Rare" = "orange",
                                "None" = "red"))+
  labs(title = "Observed vs Predicted Dam Densities, no zeros",
       x = "Predicted Maximum Capacity (dams/km)",
       y = "Observed Dam Density (dams/km)") +
  theme_classic()

#now this looks weird
```


#plot residuals
```{r}
mod1 <- lm(data = df, DamKM ~ oCC_EX)
df$residuals <- mod1$residuals


ggplot(df, aes(x = oCC_EX, y = residuals)) +
    geom_point() +
    geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
    labs(title = "Residuals vs. Fitted Values",
        x = "Fitted Values",
        y = "Residuals") +
    theme_minimal()


# Create the normal Q-Q plot
qqnorm(df$residuals, main = "Normal Q-Q Plot of Residuals")
qqline(df$residuals, col = "red")

#qqplot looks bad
```


```{r}
# Remove outliers? 
df_outliers <- subset(df, DamKM <= 50)

mod2 <- lm(data = df_outliers, DamKM ~ oCC_EX)
df_outliers$residuals <- mod2$residuals


ggplot(df_outliers, aes(x = oCC_EX, y = residuals)) +
    geom_point() +
    geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
    labs(title = "Residuals vs. Fitted Values",
        x = "Fitted Values",
        y = "Residuals") +
    theme_minimal()


# Create the normal Q-Q plot
qqnorm(df_outliers$residuals, main = "Normal Q-Q Plot of Residuals")
qqline(df_outliers$residuals, col = "red")

```
```{r}
#remove outliers and zeroes
#change 0 to NA in observed
df$DamKM_NA <- df$DamKM
df$DamKM_NA[df$DamKM_NA == 0] <- NA

df_outliers <- subset(df, DamKM_NA <= 50)

mod2 <- lm(data = df_outliers, DamKM_NA ~ oCC_EX)
df_outliers$residuals <- mod2$residuals


ggplot(df_outliers, aes(x = oCC_EX, y = residuals)) +
    geom_point() +
    geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
    labs(title = "Residuals vs. Fitted Values",
        x = "Fitted Values",
        y = "Residuals") +
    theme_minimal()


# Create the normal Q-Q plot
qqnorm(df_outliers$residuals, main = "Normal Q-Q Plot of Residuals")
qqline(df_outliers$residuals, col = "red")

#Okay so if we remove zeros and outliers >50 dams/km observed, then we get a more reasonable residual plot and a slightly more reasonable qq plot but qq is not ideal. 
#is this just not a linear model
```



###THe data is not normally distributed because the underlying fuzzy logic creates "bins" even within the continuous output, meaning that predicted dam capacity is a pseudo continuous variable that actually has bins. This means the data isn't normally distributed even if you take away the NA values and the upper outliers. So a lm/regression without any prior binning isn't going to tell us anyting. The linear model/R2 value WITH 




#########################
#IN PROGRESS#
#########################



#Test against Jordan's code
##Import table
```{r}
#Replace with your csv file name here:
df <- read_csv("BRAT4.csv")

```

##Categorize Predicted Dam Capacity
```{r}
df <- df %>% 
  mutate(category = case_when(predicted_capacity >= 15 ~ "Pervasive",
                    predicted_capacity >= 5 ~ "Frequent",
                    predicted_capacity >= 1 ~ "Occasional",
                    predicted_capacity > 0 ~ "Rare",
                    predicted_capacity == 0 ~ "None")
  )
```

##Group into categories and calculate averages
```{r}
#Grouping
grouped_df <- df %>%
  group_by(category) %>%
  summarize(mean_predicted = mean(predicted_capacity),
            mean_observed = mean(dam_density))

##re order categories by factor for plotting
grouped_df$category <- factor(grouped_df$category, levels = c("Pervasive", "Frequent", "Occasional", "Rare", "None"))

```

##Plot Observed vs Predicted (averaged by category)
```{r}
ggplot(grouped_df, aes(mean_predicted, mean_observed, col = category))+
  geom_point(size = 3)+
  stat_poly_line(mapping = aes(group = 1), se= FALSE, method="lm", color = "black") +
  stat_poly_eq(mapping = aes(group = 1)) +  #make sure statistics do not consider the color grouping, which is just for visualization
  scale_color_manual(values = c("Pervasive" = "blue",
                                "Frequent" = "green",
                                "Occasional" = "yellow",
                                "Rare" = "orange",
                                "None" = "red"))+
  labs(title = "Observed vs Predicted Dam Densities Averaged by Category",
       x = "Predicted Maximum Capacity (dams/km)",
       y = "Observed Dam Density (dams/km)") +
  theme_classic()

##Note: you will get a warning that "the following aesthetics were dropped during statistical transformation..." this is fine! I did that on purpose! 
```






